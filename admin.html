<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1>Vehicle Handover Dashboard Management</h1>
            <div>
                <button class="export-btn" id="exportCSV">Export to CSV</button>
                <button class="export-btn btn-pdf" id="exportPDF">Export to PDF</button>
            </div>
        </div>
        <div class="analytics-section">
            <h2>Handover Analytics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalInspections">0</div>
                    <div class="stat-label">Total Handovers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="approvedInspections">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingInspections">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="rejectedInspections">0</div>
                    <div class="stat-label">Rejected</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="itemsPieChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        <div class="inspections-list" id="inspectionsList"></div>
        <a href="test.html">Back to Form</a>
    </div>
    <div class="image-modal" id="imageModal">
        <div class="modal-container">
            <div class="modal-header">
                <div id="modalTitle">Inspection Image</div>
                <span class="close-modal">√ó</span>
            </div>
            <div class="modal-content">
                <div class="image-navigation">
                    <span class="nav-arrow" id="prevImage">‚ùÆ</span>
                    <span class="nav-arrow" id="nextImage">‚ùØ</span>
                </div>
                <img class="modal-image" id="modalImage">
            </div>
            <div class="image-info" id="imageInfo"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAwEY5lboxUVSdLO7cHmBSiP4rBl9Tn-Es",
            authDomain: "handoverform-15e25.firebaseapp.com",
            projectId: "handoverform-15e25",
            storageBucket: "handoverform-15e25.firebasestorage.app",
            messagingSenderId: "134922268514",
            appId: "1:134922268514:web:3e58fb5def59cb51da063b",
            measurementId: "G-QZFY6BHQ5T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            const inspectionsList = document.getElementById('inspectionsList');
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const imageInfo = document.getElementById('imageInfo');
            const closeModal = document.querySelector('.close-modal');
            const exportCSVBtn = document.getElementById('exportCSV');
            const exportPDFBtn = document.getElementById('exportPDF');
            const prevImageBtn = document.getElementById('prevImage');
            const nextImageBtn = document.getElementById('nextImage');
            const modalContent = document.querySelector('.modal-content');

            let statusChart, itemsPieChart, trendChart;
            let currentInspection = null;
            let currentInspectionImages = [];
            let currentImageIndex = 0;

            loadInspections();
            updateAnalytics();

            async function loadInspections() {
                inspectionsList.innerHTML = '<div class="no-inspections">Loading inspections...</div>';
                try {
                    const querySnapshot = await getDocs(collection(db, 'inspections'));
                    renderInspections(querySnapshot);
                } catch (error) {
                    console.error('Error loading inspections:', error);
                    inspectionsList.innerHTML = '<div class="no-inspections">Error loading inspections. Please try again.</div>';
                }
            }

            function renderInspections(querySnapshot) {
                inspectionsList.innerHTML = '';
                const inspections = [];
                querySnapshot.forEach(doc => inspections.push({ id: doc.id, ...doc.data() }));

                if (inspections.length === 0) {
                    inspectionsList.innerHTML = '<div class="no-inspections">No inspections found.</div>';
                    return;
                }

                inspections.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                inspections.forEach(inspection => {
                    const card = document.createElement('div');
                    card.className = 'inspection-card';
                    const uploadedImages = inspection.uploadedImages || [];
                    const inspectionItems = inspection.inspectionItems || [];

                    card.innerHTML = `
                        <h3>Handover #${inspection.id}</h3>
                        <p><strong>Courier Name:</strong> ${inspection.courierName || 'N/A'}</p>
                        <p><strong>Iquama Number:</strong> ${inspection.iquamaNumber || 'N/A'}</p>
                        <p><strong>Plate Number:</strong> ${inspection.plateNumber || 'N/A'}</p>
                        <p><strong>Mobile Number:</strong> ${inspection.mobileNumber || 'N/A'}</p>
                        <p><strong>Checked By:</strong> ${inspection.checkedBy || 'N/A'}</p>
                        <p><strong>Odometer:</strong> ${inspection.odometer || 'N/A'}</p>
                        <p><strong>Date:</strong> ${inspection.timestamp ? new Date(inspection.timestamp).toLocaleString() : 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="status-${inspection.status}">${inspection.status || 'pending'}</span></p>
                        <p><strong>Marked Points:</strong> ${inspection.selectedPoints ? inspection.selectedPoints.length : 0}</p>
                        <p><strong>Inspection Items:</strong> ${inspectionItems.length > 0 ? inspectionItems.map(item => {
                            if (item === 'tools') return 'üõ†Ô∏è Tools';
                            if (item === 'fireExtinguisher') return 'üßØ Fire Extinguisher';
                            if (item === 'spareTire') return '‚ö´ Spare Tire';
                            if (item === 'medicalKit') return 'üß∞ Medical Kit';
                            return item;
                        }).join(', ') : 'None'}</p>
                    `;

                    const gallery = document.createElement('div');
                    gallery.className = 'image-gallery';
                    const galleryHeader = document.createElement('div');
                    galleryHeader.className = 'gallery-header';
                    galleryHeader.innerHTML = `
                        <span class="gallery-title">Images</span>
                        <span class="image-count">${uploadedImages.length}</span>
                    `;
                    const thumbnailGrid = document.createElement('div');
                    thumbnailGrid.className = 'thumbnail-grid';

                    if (uploadedImages.length > 0) {
                        uploadedImages.forEach((img, index) => {
                            const thumbnailContainer = document.createElement('div');
                            thumbnailContainer.className = 'thumbnail-container';
                            const thumbnail = document.createElement('img');
                            thumbnail.className = 'thumbnail-img';
                            thumbnail.src = img.url;
                            thumbnail.dataset.index = index;
                            thumbnail.dataset.inspection = inspection.id;
                            thumbnailContainer.appendChild(thumbnail);
                            thumbnailGrid.appendChild(thumbnailContainer);
                        });
                    } else {
                        thumbnailGrid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666;">No images available</p>';
                    }

                    gallery.appendChild(galleryHeader);
                    gallery.appendChild(thumbnailGrid);
                    card.appendChild(gallery);

                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'action-buttons';
                    if (inspection.status === 'pending') {
                        buttonsDiv.innerHTML += `
                            <button class="btn btn-approve" data-id="${inspection.id}">Approve</button>
                            <button class="btn btn-reject" data-id="${inspection.id}">Reject</button>
                        `;
                    }
                    buttonsDiv.innerHTML += `<button class="btn btn-delete" data-id="${inspection.id}">Delete</button>`;
                    card.appendChild(buttonsDiv);
                    inspectionsList.appendChild(card);
                });

                document.querySelectorAll('.thumbnail-img').forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        const inspectionId = thumb.dataset.inspection;
                        const imgIndex = parseInt(thumb.dataset.index);
                        const inspection = inspections.find(i => i.id === inspectionId);
                        if (inspection) {
                            currentInspection = inspection;
                            currentInspectionImages = inspection.uploadedImages || [];
                            currentImageIndex = imgIndex;
                            if (currentInspectionImages.length > 0) {
                                updateModalImage();
                                imageModal.style.display = 'flex';
                                modalImage.classList.remove('zoomed');
                            }
                        }
                    });
                });

                document.querySelectorAll('.btn-approve').forEach(btn => {
                    btn.addEventListener('click', () => updateInspectionStatus(btn.dataset.id, 'approved'));
                });

                document.querySelectorAll('.btn-reject').forEach(btn => {
                    btn.addEventListener('click', () => updateInspectionStatus(btn.dataset.id, 'rejected'));
                });

                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (confirm('Are you sure you want to delete this handover?')) {
                            deleteInspection(btn.dataset.id);
                        }
                    });
                });
            }

            function updateModalImage() {
                if (currentInspectionImages.length === 0) return;
                const image = currentInspectionImages[currentImageIndex];
                modalImage.src = image.url;
                modalTitle.textContent = `Handover #${currentInspection.id} - Image ${currentImageIndex + 1}`;
                imageInfo.textContent = `${currentImageIndex + 1} of ${currentInspectionImages.length} images`;

                let zoomControls = document.querySelector('.zoom-controls');
                if (!zoomControls) {
                    zoomControls = document.createElement('div');
                    zoomControls.className = 'zoom-controls';
                    zoomControls.innerHTML = `
                        <button class="zoom-btn" id="zoomIn">+</button>
                        <button class="zoom-btn" id="zoomOut">-</button>
                    `;
                    modalContent.appendChild(zoomControls);
                    document.getElementById('zoomIn').addEventListener('click', () => modalImage.classList.add('zoomed'));
                    document.getElementById('zoomOut').addEventListener('click', () => modalImage.classList.remove('zoomed'));
                }
            }

            function showNextImage() {
                if (currentInspectionImages.length === 0) return;
                currentImageIndex = (currentImageIndex + 1) % currentInspectionImages.length;
                updateModalImage();
            }

            function showPrevImage() {
                if (currentInspectionImages.length === 0) return;
                currentImageIndex = (currentImageIndex - 1 + currentInspectionImages.length) % currentInspectionImages.length;
                updateModalImage();
            }

            nextImageBtn.addEventListener('click', showNextImage);
            prevImageBtn.addEventListener('click', showPrevImage);
            document.addEventListener('keydown', e => {
                if (imageModal.style.display === 'flex') {
                    if (e.key === 'ArrowRight') showNextImage();
                    else if (e.key === 'ArrowLeft') showPrevImage();
                    else if (e.key === 'Escape') imageModal.style.display = 'none';
                }
            });
            closeModal.addEventListener('click', () => imageModal.style.display = 'none');
            imageModal.addEventListener('click', e => {
                if (e.target === imageModal) imageModal.style.display = 'none';
            });
            modalImage.addEventListener('click', () => modalImage.classList.toggle('zoomed'));

            async function updateInspectionStatus(id, status) {
                try {
                    const inspectionRef = doc(db, 'inspections', id);
                    await updateDoc(inspectionRef, { status });
                    loadInspections();
                    updateAnalytics();
                    alert(`Inspection #${id} has been ${status}`);
                } catch (error) {
                    console.error('Error updating inspection:', error);
                    alert('Error updating inspection. Please try again.');
                }
            }

            async function deleteInspection(id) {
                try {
                    await deleteDoc(doc(db, 'inspections', id));
                    loadInspections();
                    updateAnalytics();
                    alert(`Handover #${id} has been deleted`);
                } catch (error) {
                    console.error('Error deleting inspection:', error);
                    alert('Error deleting inspection.');
                }
            }

            async function updateAnalytics() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'inspections'));
                    const inspections = [];
                    querySnapshot.forEach(doc => inspections.push({ id: doc.id, ...doc.data() }));
                    updateStats(inspections);
                    updateCharts(inspections);
                } catch (error) {
                    console.error('Error loading analytics:', error);
                }
            }

            function updateStats(inspections) {
                document.getElementById('totalInspections').textContent = inspections.length;
                document.getElementById('approvedInspections').textContent = inspections.filter(i => i.status === 'approved').length;
                document.getElementById('pendingInspections').textContent = inspections.filter(i => i.status === 'pending').length;
                document.getElementById('rejectedInspections').textContent = inspections.filter(i => i.status === 'rejected').length;
            }

            function updateCharts(inspections) {
                if (statusChart) statusChart.destroy();
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                statusChart = new Chart(statusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Approved', 'Pending', 'Rejected'],
                        datasets: [{
                            label: 'Inspection Status',
                            data: [
                                inspections.filter(i => i.status === 'approved').length,
                                inspections.filter(i => i.status === 'pending').length,
                                inspections.filter(i => i.status === 'rejected').length
                            ],
                            backgroundColor: ['#38a169', '#d69e2e', '#e53e3e'],
                            borderColor: ['#2f855a', '#b7791f', '#c53030'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Handover Status Distribution', font: { size: 16 } }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });

                if (itemsPieChart) itemsPieChart.destroy();
                const itemsCounts = { tools: 0, fireExtinguisher: 0, spareTire: 0, medicalKit: 0 };
                inspections.forEach(i => {
                    (i.inspectionItems || []).forEach(item => {
                        if (item in itemsCounts) itemsCounts[item]++;
                    });
                });
                const itemsPieCtx = document.getElementById('itemsPieChart').getContext('2d');
                itemsPieChart = new Chart(itemsPieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Tools', 'Fire Extinguisher', 'Spare Tire', 'Medical Kit'],
                        datasets: [{
                            data: [itemsCounts.tools, itemsCounts.fireExtinguisher, itemsCounts.spareTire, itemsCounts.medicalKit],
                            backgroundColor: ['#3182ce', '#ed8936', '#805ad5', '#48bb78'],
                            borderColor: ['#fff', '#fff', '#fff', '#fff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 14 } } },
                            title: { display: true, text: 'Handover Items Distribution', font: { size: 16 } }
                        }
                    }
                });

                if (trendChart) trendChart.destroy();
                const trendData = {};
                inspections.forEach(i => {
                    const date = new Date(i.timestamp).toISOString().slice(0, 10);
                    trendData[date] = (trendData[date] || 0) + 1;
                });
                const sortedDates = Object.keys(trendData).sort();
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Handovers per Day',
                            data: sortedDates.map(date => trendData[date]),
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49, 130, 206, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: 'Handover Trends Over Time', font: { size: 16 } }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } },
                            x: { ticks: { maxTicksLimit: 10 } }
                        }
                    }
                });
            }

            exportCSVBtn.addEventListener('click', async () => {
                try {
                    const querySnapshot = await getDocs(collection(db, 'inspections'));
                    const inspections = [];
                    querySnapshot.forEach(doc => inspections.push({ id: doc.id, ...doc.data() }));

                    if (inspections.length === 0) {
                        alert('No inspections to export');
                        return;
                    }

                    let csvContent = "ID,Courier Name,Iquama Number,Plate Number,Mobile Number,Odometer,Checked By,Date,Status,Marked Points,Image Count,Inspection Items\n";
                    inspections.forEach(inspection => {
                        const images = inspection.uploadedImages || [];
                        const inspectionItems = inspection.inspectionItems || [];
                        csvContent += `
                            ${inspection.id},
                            "${String(inspection.courierName || '').replace(/"/g, '""')}",
                            ${inspection.iquamaNumber || ''},
                            "${String(inspection.plateNumber || '').replace(/"/g, '""')}",
                            ${inspection.mobileNumber || ''},
                            ${inspection.odometer || ''},
                            "${String(inspection.checkedBy || '').replace(/"/g, '""')}",
                            "${inspection.timestamp ? new Date(inspection.timestamp).toLocaleString() : ''}",
                            ${inspection.status || 'pending'},
                            ${inspection.selectedPoints ? inspection.selectedPoints.length : 0},
                            ${images.length},
                            "${inspectionItems.join(', ')}"
                        `.replace(/\n\s*/g, '').trim() + '\n';
                    });

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', `handovers_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    alert('Error exporting CSV.');
                }
            });

            exportPDFBtn.addEventListener('click', async () => {
                try {
                    const querySnapshot = await getDocs(collection(db, 'inspections'));
                    const inspections = [];
                    querySnapshot.forEach(doc => inspections.push({ id: doc.id, ...doc.data() }));

                    if (inspections.length === 0) {
                        alert('No inspections to export');
                        exportPDFBtn.innerHTML = 'Export to PDF';
                        exportPDFBtn.disabled = false;
                        return;
                    }

                    exportPDFBtn.innerHTML = '<span class="loading"></span> Generating PDF...';
                    exportPDFBtn.disabled = true;

                    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                    // Cover Page
                    doc.setFontSize(24);
                    doc.setTextColor(40, 53, 147);
                    doc.text('Vehicle Handover Report', 105, 20, { align: 'center' });
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 35, { align: 'center' });

                    const approved = inspections.filter(i => i.status === 'approved').length;
                    const pending = inspections.filter(i => i.status === 'pending').length;
                    const rejected = inspections.filter(i => i.status === 'rejected').length;

                    doc.setFontSize(14);
                    doc.text('Handover Summary', 105, 50, { align: 'center' });
                    doc.setLineWidth(0.5);
                    doc.setDrawColor(40, 53, 147);
                    doc.line(50, 55, 160, 55);
                    doc.setFontSize(12);
                    doc.text(`Total Handovers: ${inspections.length}`, 105, 65, { align: 'center' });
                    doc.text(`Approved: ${approved}`, 105, 75, { align: 'center' });
                    doc.text(`Pending: ${pending}`, 105, 85, { align: 'center' });
                    doc.text(`Rejected: ${rejected}`, 105, 95, { align: 'center' });

                    // Detailed Inspections
                    for (const [index, inspection] of inspections.entries()) {
                        doc.addPage();
                        doc.setFontSize(18);
                        doc.setTextColor(40, 53, 147);
                        doc.text(`Handover #${inspection.id || 'N/A'}`, 14, 20);
                        doc.setLineWidth(0.3);
                        doc.setDrawColor(40, 53, 147);
                        doc.line(14, 25, 196, 25);
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);

                        doc.text('Handover Details', 14, 32);
                        doc.text(`Courier Name: ${inspection.courierName || 'N/A'}`, 14, 40);
                        doc.text(`Iquama Number: ${inspection.iquamaNumber || 'N/A'}`, 14, 46);
                        doc.text(`Plate Number: ${inspection.plateNumber || 'N/A'}`, 14, 52);
                        doc.text(`Mobile Number: ${inspection.mobileNumber || 'N/A'}`, 14, 58);
                        doc.text(`Checked By: ${inspection.checkedBy || 'N/A'}`, 14, 64);
                        doc.text(`Odometer: ${inspection.odometer || 'N/A'}`, 14, 70);
                        doc.text(`Date: ${inspection.timestamp ? new Date(inspection.timestamp).toLocaleString() : 'N/A'}`, 110, 40);
                        doc.text(`Status: ${inspection.status || 'pending'}`, 110, 46);
                        doc.text(`Marked Points: ${inspection.selectedPoints ? inspection.selectedPoints.length : 0}`, 110, 52);

                        const inspectionItems = inspection.inspectionItems || [];
                        doc.text(`Handover Items: ${inspectionItems.length > 0 ? inspectionItems.map(item => {
                            if (item === 'tools') return 'Tools';
                            if (item === 'fireExtinguisher') return 'Fire Extinguisher';
                            if (item === 'spareTire') return 'Spare Tire';
                            if (item === 'medicalKit') return 'Medical Kit';
                            return item;
                        }).join(', ') : 'None'}`, 14, 76);

                        const uploadedImages = inspection.uploadedImages || [];
                        let yPosition = 86;

                        if (uploadedImages.length > 0) {
                            doc.setFontSize(14);
                            doc.text('Handover Images', 14, yPosition);
                            doc.setLineWidth(0.3);
                            doc.line(14, yPosition + 2, 196, yPosition + 2);
                            yPosition += 8;

                            const imgWidth = 70;
                            const imgHeight = 40;
                            const imagesPerRow = 3;
                            let imagesInCurrentRow = 0;
                            let xPosition = 14;

                            for (const [i, img] of uploadedImages.entries()) {
                                if (yPosition + imgHeight > 280) {
                                    doc.addPage();
                                    yPosition = 20;
                                    xPosition = 14;
                                    imagesInCurrentRow = 0;
                                    doc.setFontSize(14);
                                    doc.text('Handover Images (Continued)', 14, yPosition);
                                    doc.setLineWidth(0.3);
                                    doc.line(14, yPosition + 2, 196, yPosition + 2);
                                    yPosition += 8;
                                }

                                if (imagesInCurrentRow >= imagesPerRow) {
                                    yPosition += imgHeight + 10;
                                    xPosition = 14;
                                    imagesInCurrentRow = 0;

                                    if (yPosition + imgHeight > 280) {
                                        doc.addPage();
                                        yPosition = 20;
                                        xPosition = 14;
                                        imagesInCurrentRow = 0;
                                        doc.setFontSize(14);
                                        doc.text('Handover Images (Continued)', 14, yPosition);
                                        doc.setLineWidth(0.3);
                                        doc.line(14, yPosition + 2, 196, yPosition + 2);
                                        yPosition += 8;
                                    }
                                }

                                try {
                                    const imgObj = new Image();
                                    imgObj.src = img.url;
                                    await new Promise((resolve, reject) => {
                                        imgObj.onload = resolve;
                                        imgObj.onerror = () => reject(new Error(`Failed to load image: ${img.url}`));
                                    });

                                    const aspectRatio = imgObj.width / imgObj.height;
                                    let finalWidth = imgWidth;
                                    let finalHeight = finalWidth / aspectRatio;

                                    if (finalHeight > imgHeight) {
                                        finalHeight = imgHeight;
                                        finalWidth = finalHeight * aspectRatio;
                                    }

                                    doc.addImage(imgObj, 'JPEG', xPosition, yPosition, finalWidth, finalHeight);
                                    xPosition += finalWidth + 5;
                                    imagesInCurrentRow++;

                                    if (imagesInCurrentRow >= imagesPerRow) {
                                        yPosition += finalHeight + 5;
                                    }
                                } catch (error) {
                                    console.error('Error adding image to PDF:', error);
                                    doc.text('(Error loading image)', xPosition, yPosition + 5);
                                    xPosition += 60;
                                    imagesInCurrentRow++;
                                }
                            }
                        } else {
                            doc.text('No images available', 14, yPosition);
                        }
                    }

                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Page ${i} of ${totalPages}`, 200, 285, { align: 'right' });
                    }

                    doc.save(`vehicle_inspections_${new Date().toISOString().slice(0, 10)}.pdf`);
                } catch (error) {
                    console.error('PDF Generation Error:', error);
                    alert('Error generating PDF: ' + error.message);
                } finally {
                    exportPDFBtn.innerHTML = 'Export to PDF';
                    exportPDFBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
