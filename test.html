<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Handover Form</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="form-container">
        <img src="logo.svg" alt="Company Logo" class="form-logo">
        <h2>Vehicle Handover Form</h2>
        <form id="inspectionForm">
            <!-- Personal Information -->
            <div class="form-group">
                <label for="plateNumber">Plate Number (لوحة السيارة)</label>
                <input type="text" id="plateNumber" name="plateNumber" required>
                <div class="error" id="plateNumberError">Plate number must be alphanumeric with spaces or hyphens (max 10 characters)</div>
            </div>
            <div class="form-group">
                <label for="courierName">Courier Name (اسم المندوب)</label>
                <input type="text" id="courierName" name="courierName" required>
                <div class="error" id="courierNameError">Courier name must contain letters and spaces only</div>
            </div>
            <div class="form-group">
                <label for="iquamaNumber">Iquama Number (رقم الاقامة)</label>
                <input type="text" id="iquamaNumber" name="iquamaNumber" required>
                <div class="error" id="iquamaNumberError">Iquama number must be exactly 10 digits</div>
            </div>
            <div class="form-group">
                <label for="mobileNumber">Mobile Number (رقم الجوال)</label>
                <input type="text" id="mobileNumber" name="mobileNumber" required>
                <div class="error" id="mobileError">Mobile number must be exactly 9 digits</div>
            </div>
            <div class="form-group">
                <label for="odometer">ODO Meter (العداد)</label>
                <input type="number" id="odometer" name="odometer" required min="0" step="1">
                <div class="error" id="odometerError">ODO Meter must be a non-negative integer</div>
            </div>
            <div class="form-group">
                <label for="checkedBy">Checked By (فحص من طرف)</label>
                <input type="text" id="checkedBy" name="checkedBy" required>
                <div class="error" id="checkedByError">Checked by must contain letters and spaces only</div>
            </div>
            <!-- Vehicle Damage and Inspection Items -->
            <div class="form-group">
                <label for="selectableImage">Click on the vehicle image to mark the damage points (optional):</label>
                <div class="image-container">
                    <img id="selectableImage" src="" alt="Vehicle" style="max-width: 100%; height: auto;">
                    <input type="hidden" id="selectedPoints" name="selectedPoints">
                </div>
            </div>
            <div class="form-group">
                <label>Select what you have:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="tools" name="inspectionItems" value="tools"><span>🛠️ Tools</span></label>
                    <label><input type="checkbox" id="fireExtinguisher" name="inspectionItems" value="fireExtinguisher"><span>🧯 Fire Extinguisher</span></label>
                    <label><input type="checkbox" id="spareTire" name="inspectionItems" value="spareTire"><span>⚫ Spare Tire</span></label>
                    <label><input type="checkbox" id="medicalKit" name="inspectionItems" value="medicalKit"><span>🧰 Medical Kit</span></label>
                </div>
            </div>
            <!-- Image Upload -->
            <div class="form-group">
                <label for="imageUpload">Upload Additional Photos</label>
                <input type="file" id="imageUpload" name="imageUpload" accept="image/*" capture="environment" multiple>
                <button type="button" class="camera-btn" id="openCamera">Open Camera</button>
                <div class="uploaded-images" id="uploadedImages"></div>
            </div>
            <!-- Buttons -->
            <div class="form-group buttons">
                <button type="submit">Submit Inspection</button>
                <button type="button" id="clearMarks">Clear All Marks</button>
                <button type="button" id="saveMarkedImage">Save Marked Image</button>
            </div>
        </form>
        <div id="successMessage" class="success-message">Form submitted successfully!</div>
        <a href="admin.html">Go to Admin Dashboard</a>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.18.0/firebase-app.js';
        import { getFirestore, collection, addDoc, setLogLevel } from 'https://www.gstatic.com/firebasejs/10.18.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.18.0/firebase-storage.js';

        setLogLevel('debug');

        const firebaseConfig = {
            apiKey: "AIzaSyAwEY5lboxUVSdLO7cHmBSiP4rBl9Tn-Es",
            authDomain: "handoverform-15e25.firebaseapp.com",
            projectId: "handoverform-15e25",
            storageBucket: "handoverform-15e25.firebasestorage.app",
            messagingSenderId: "134922268514",
            appId: "1:134922268514:web:3e58fb5def59cb51da063b",
            measurementId: "G-QZFY6BHQ5T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('inspectionForm');
            const plateNumberInput = document.getElementById('plateNumber');
            const courierNameInput = document.getElementById('courierName');
            const iquamaNumberInput = document.getElementById('iquamaNumber');
            const mobileNumberInput = document.getElementById('mobileNumber');
            const odometerInput = document.getElementById('odometer');
            const checkedByInput = document.getElementById('checkedBy');
            const plateNumberError = document.getElementById('plateNumberError');
            const courierNameError = document.getElementById('courierNameError');
            const iquamaNumberError = document.getElementById('iquamaNumberError');
            const mobileError = document.getElementById('mobileError');
            const odometerError = document.getElementById('odometerError');
            const checkedByError = document.getElementById('checkedByError');
            const image = document.getElementById('selectableImage');
            const container = document.querySelector('.image-container');
            const clearBtn = document.getElementById('clearMarks');
            const saveMarkedImageBtn = document.getElementById('saveMarkedImage');
            const selectedPointsInput = document.getElementById('selectedPoints');
            const imageUpload = document.getElementById('imageUpload');
            const openCameraBtn = document.getElementById('openCamera');
            const uploadedImagesContainer = document.getElementById('uploadedImages');
            const successMessage = document.getElementById('successMessage');

            let points = [];
            let uploadedImages = [];
            let naturalWidth, naturalHeight;

            function loadDefaultImage() {
                if (image) {
                    image.src = 'data:image/jpeg;base64,/9j/4AAQSkZ...[YOUR_FULL_BASE64_STRING_HERE]';
                    image.onload = () => {
                        naturalWidth = image.naturalWidth;
                        naturalHeight = image.naturalHeight;
                    };
                    image.onerror = () => {
                        console.error('Failed to load base64 image. Using default dimensions.');
                        naturalWidth = 800;
                        naturalHeight = 600;
                    };
                } else {
                    console.error('Image element with ID "selectableImage" not found.');
                }
            }
            loadDefaultImage();

            function validatePlateNumber() {
                const plateRegex = /^[A-Za-z0-9\s-]{1,10}$/;
                const isValid = plateRegex.test(plateNumberInput.value.trim());
                plateNumberError.classList.toggle('show', !isValid && plateNumberInput.value);
                return isValid;
            }

            function validateCourierName() {
                const nameRegex = /^[A-Za-z\s]+$/;
                const isValid = nameRegex.test(courierNameInput.value.trim());
                courierNameError.classList.toggle('show', !isValid && courierNameInput.value);
                return isValid;
            }

            function validateIquamaNumber() {
                const idRegex = /^\d{10}$/;
                const isValid = idRegex.test(iquamaNumberInput.value.trim());
                iquamaNumberError.classList.toggle('show', !isValid && iquamaNumberInput.value);
                return isValid;
            }

            function validateMobileNumber() {
                const mobileRegex = /^\d{9}$/;
                const isValid = mobileRegex.test(mobileNumberInput.value.trim());
                mobileError.classList.toggle('show', !isValid && mobileNumberInput.value);
                return isValid;
            }

            function validateOdometer() {
                const isValid = odometerInput.value >= 0 && Number.isInteger(Number(odometerInput.value));
                odometerError.classList.toggle('show', !isValid && odometerInput.value);
                return isValid;
            }

            function validateCheckedBy() {
                const nameRegex = /^[A-Za-z\s]+$/;
                const isValid = nameRegex.test(checkedByInput.value.trim());
                checkedByError.classList.toggle('show', !isValid && checkedByInput.value);
                return isValid;
            }

            plateNumberInput.addEventListener('input', validatePlateNumber);
            courierNameInput.addEventListener('input', validateCourierName);
            iquamaNumberInput.addEventListener('input', validateIquamaNumber);
            mobileNumberInput.addEventListener('input', validateMobileNumber);
            odometerInput.addEventListener('input', validateOdometer);
            checkedByInput.addEventListener('input', validateCheckedBy);

            image.addEventListener('click', (e) => {
                if (!naturalWidth || !naturalHeight) {
                    alert('Image not fully loaded yet');
                    return;
                }
                const rect = image.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const xPercent = (x / rect.width) * 100;
                const yPercent = (y / rect.height) * 100;
                points.push({ x: xPercent, y: yPercent });
                selectedPointsInput.value = JSON.stringify(points);
                createMarker(xPercent, yPercent);
            });

            function createMarker(xPercent, yPercent) {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.innerHTML = 'X';
                marker.style.left = xPercent + '%';
                marker.style.top = yPercent + '%';
                container.appendChild(marker);
            }

            clearBtn.addEventListener('click', () => {
                document.querySelectorAll('.marker').forEach(marker => marker.remove());
                points = [];
                selectedPointsInput.value = '';
            });

            saveMarkedImageBtn.addEventListener('click', async () => {
                if (points.length === 0) {
                    alert('Please mark at least one point on the image');
                    return;
                }
                try {
                    const markedImageData = await captureMarkedImage();
                    uploadedImages.push({ url: markedImageData, isMarkedImage: true });
                    displayUploadedImage(markedImageData, true);
                    alert('Marked image saved successfully');
                } catch (error) {
                    console.error('Error capturing marked image:', error);
                    alert('Error saving marked image. Please try again.');
                }
            });

            imageUpload.addEventListener('change', (e) => handleFiles(e.target.files));
            openCameraBtn.addEventListener('click', () => imageUpload.click());

            function handleFiles(files) {
                if (files.length + uploadedImages.length > 10) {
                    alert('Maximum 10 images allowed');
                    return;
                }
                for (let file of files) {
                    if (!file.type.startsWith('image/')) continue;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageData = e.target.result;
                        uploadedImages.push({ url: imageData, isMarkedImage: false });
                        displayUploadedImage(imageData, false);
                    };
                    reader.readAsDataURL(file);
                }
            }

            function displayUploadedImage(imageData, isMarkedImage) {
                const imageElement = document.createElement('div');
                imageElement.className = 'uploaded-image';
                const img = document.createElement('img');
                img.src = imageData;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', () => {
                    const index = uploadedImages.findIndex(img => img.url === imageData);
                    if (index !== -1) uploadedImages.splice(index, 1);
                    imageElement.remove();
                });
                if (isMarkedImage) {
                    const markedBadge = document.createElement('div');
                    markedBadge.style.position = 'absolute';
                    markedBadge.style.top = '2px';
                    markedBadge.style.left = '2px';
                    markedBadge.style.backgroundColor = '#f44336';
                    markedBadge.style.color = 'white';
                    markedBadge.style.padding = '2px 5px';
                    markedBadge.style.borderRadius = '3px';
                    markedBadge.style.fontSize = '10px';
                    markedBadge.style.fontWeight = 'bold';
                    markedBadge.textContent = 'Marked';
                    imageElement.appendChild(markedBadge);
                }
                imageElement.appendChild(img);
                imageElement.appendChild(removeBtn);
                uploadedImagesContainer.appendChild(imageElement);
            }

            function captureMarkedImage() {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = image.naturalWidth;
                    canvas.height = image.naturalHeight;
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                    points.forEach(point => {
                        const x = (point.x / 100) * canvas.width;
                        const y = (point.y / 100) * canvas.height;
                        ctx.beginPath();
                        ctx.arc(x, y, 15, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(207, 42, 31, 0.7)';
                        ctx.fill();
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 20px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('X', x, y);
                    });
                    const markedImageData = canvas.toDataURL('image/jpeg', 0.9);
                    resolve(markedImageData);
                });
            }

            async function uploadImageToStorage(imageData, path) {
                try {
                    const blob = await fetch(imageData).then(res => res.blob());
                    const storageRef = ref(storage, path);
                    await uploadBytes(storageRef, blob);
                    return getDownloadURL(storageRef);
                } catch (error) {
                    console.error('Storage upload error:', error);
                    throw error;
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const isPlateValid = validatePlateNumber();
                const isCourierNameValid = validateCourierName();
                const isIquamaValid = validateIquamaNumber();
                const isMobileValid = validateMobileNumber();
                const isOdometerValid = validateOdometer();
                const isCheckedByValid = validateCheckedBy();
                const hasImages = uploadedImages.length > 0;
                const hasPoints = points.length > 0;

                if (hasPoints && !hasImages) {
                    alert('Please save the marked image or upload additional photos since you have marked points');
                    return;
                }

                if (isPlateValid && isCourierNameValid && isIquamaValid && isMobileValid && isOdometerValid && isCheckedByValid) {
                    const inspectionItems = [];
                    if (document.getElementById('tools').checked) inspectionItems.push('tools');
                    if (document.getElementById('fireExtinguisher').checked) inspectionItems.push('fireExtinguisher');
                    if (document.getElementById('spareTire').checked) inspectionItems.push('spareTire');
                    if (document.getElementById('medicalKit').checked) inspectionItems.push('medicalKit');

                    const imageUrls = [];
                    const timestamp = new Date().toISOString();
                    try {
                        for (let i = 0; i < uploadedImages.length; i++) {
                            const path = `inspections/${timestamp}_${i}.jpg`;
                            const url = await uploadImageToStorage(uploadedImages[i].url, path);
                            imageUrls.push({ url, isMarkedImage: uploadedImages[i].isMarkedImage });
                        }

                        const inspectionData = {
                            plateNumber: plateNumberInput.value.trim(),
                            courierName: courierNameInput.value.trim(),
                            iquamaNumber: iquamaNumberInput.value.trim(),
                            mobileNumber: mobileNumberInput.value.trim(),
                            odometer: odometerInput.value.trim(),
                            checkedBy: checkedByInput.value.trim(),
                            selectedPoints: Array.isArray(points) ? points : [],
                            uploadedImages: Array.isArray(imageUrls) ? imageUrls : [],
                            inspectionItems: Array.isArray(inspectionItems) ? inspectionItems : [],
                            timestamp,
                            status: 'pending'
                        };
                        console.log('inspectionData:', JSON.stringify(inspectionData, null, 2));
                        await addDoc(collection(db, 'inspections'), inspectionData);
                        successMessage.style.display = 'block';
                        document.querySelector('.form-container').style.opacity = '0.5';
                        document.querySelector('.form-container').style.pointerEvents = 'none';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                            form.reset();
                            points = [];
                            selectedPointsInput.value = '';
                            uploadedImages = [];
                            uploadedImagesContainer.innerHTML = '';
                            document.querySelectorAll('.marker').forEach(m => m.remove());
                            document.querySelector('.form-container').style.opacity = '1';
                            document.querySelector('.form-container').style.pointerEvents = 'auto';
                            loadDefaultImage();
                        }, 3000);
                    } catch (error) {
                        console.error('Error submitting form:', error);
                        alert('Error submitting inspection: ' + error.message);
                    }
                } else {
                    alert('Please correct the errors in the form');
                }
            });
        });
    </script>
</body>
</html>
